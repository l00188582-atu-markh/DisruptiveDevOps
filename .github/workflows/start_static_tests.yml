name: Standard_Tests_Static

# Simuulates running 3 sets of tests in succession, each having their own environment

on: 
  workflow_dispatch

jobs:
  log-SIT-call:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    steps:
      - name: checkout-repo
        uses: actions/checkout@v3

      - name: get-date
        id: start-date
        run: echo "::set-output name=date::$(date)"
        
      - name: first-log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: overwrite
          contents: "Static workflow started @ ${{ steps.start-date.outputs.date }}\n"
    
      - name: log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: append
          contents: "Starting SIT Tests @ ${{ steps.start-date.outputs.date }}\n"  

      - name: commit-log-entry
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          branch: main
          commit_message: "Update logs @ ${{ steps.start-date.outputs.date }}"
          push_options: '--force'
               
  run-SIT-tests:
    needs: log-SIT-call
    uses: ./.github/workflows/[REUSABLE]-static-tests.yml
    with:
      environment: SIT
      
  log-UAT-call:
    runs-on: ubuntu-latest
    needs: run-SIT-tests
    permissions: 
      contents: write
    steps:
      - name: checkout-repo
        uses: actions/checkout@v3

      - name: get-date
        id: start-date
        run: echo "::set-output name=date::$(date)"
        
      - name: log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: append
          contents: "Starting SIT Tests @ ${{ steps.start-date.outputs.date }}\n"

      - name: commit-log-entry
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          branch: main
          commit_message: "Update logs @ ${{ steps.start-date.outputs.date }}"
          push_options: '--force'
  
  log-long-running-start:
    runs-on: ubuntu-latest
    needs: run-SIT-tests
    permissions: 
      contents: write
    steps:
      - name: checkout-repo
        uses: actions/checkout@v3

      - name: get-date
        id: start-date
        run: echo "::set-output name=date::$(date)"
        
      - name: log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: append
          contents: "Starting long-running process @ ${{ steps.start-date.outputs.date }}\n"

      - name: commit-log-entry
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          branch: main
          commit_message: "Update logs @ ${{ steps.start-date.outputs.date }}"
          push_options: '--force'
  
  start-long-running-process:
    needs: log-long-running-start
    uses: ./.github/workflows/[REUSABLE]-static-long-running.yml
    secrets: inherit

  snooze:
    needs: log-UAT-call
    runs-on: ubuntu-latest
    steps:
      - name: call_sleep_timer
        shell: bash
        run: sleep 10
        
  run-UAT-tests:
    needs: snooze # this is to make sure the long-running process grabs the resource first
    uses: ./.github/workflows/[REUSABLE]-static-tests.yml
    with: 
      environment: UAT

  log-ORT-call:
    needs: run-UAT-tests
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    steps:
      - name: checkout-repo
        uses: actions/checkout@v3

      - name: get-date
        id: start-date
        run: echo "::set-output name=date::$(date)"
        
      - name: log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: append
          contents: "Starting ORT tests @ ${{ steps.start-date.outputs.date }}\n"

      - name: commit-log-entry
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          branch: main
          commit_message: "Update logs @ ${{ steps.start-date.outputs.date }}"
          push_options: '--force'

  run-ORT-tests:
    needs: log-ORT-call
    uses: ./.github/workflows/[REUSABLE]-static-tests.yml
    with:
      environment: ORT

  log-ORT-end:
    needs: run-ORT-tests
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    steps:
      - name: checkout-repo
        uses: actions/checkout@v3

      - name: get-date
        id: start-date
        run: echo "::set-output name=date::$(date)"
        
      - name: log-entry
        uses: DamianReeves/write-file-action@master
        with: 
          path: ./logs/static_log.txt
          write-mode: append
          contents: "Finished ORT tests @ ${{ steps.start-date.outputs.date }}\n"

      - name: commit-log-entry
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          branch: main
          commit_message: "Update logs @ ${{ steps.start-date.outputs.date }}"
          push_options: '--force'    
